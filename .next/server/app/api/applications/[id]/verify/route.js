"use strict";(()=>{var e={};e.id=418,e.ids=[418],e.modules={5890:e=>{e.exports=require("better-sqlite3")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6005:e=>{e.exports=require("node:crypto")},7965:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>h,requestAsyncStorage:()=>_,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{POST:()=>m,dynamic:()=>d});var n=r(9303),i=r(8716),o=r(670),s=r(7070),l=r(2704),p=r(909),c=r(354),u=r(307);let d="force-dynamic";async function m(e,{params:t}){try{let r=await (0,l.m)(e);if(r instanceof s.NextResponse)return r;let{user:a}=r,n=parseInt(t.id);if(isNaN(n))return s.NextResponse.json({error:"Invalid application ID"},{status:400});let i=p.M1.findById(n);if(!i)return s.NextResponse.json({error:"Application not found"},{status:404});let o=p.uH.findByApplicationId(n);if(0===o.length)return s.NextResponse.json({error:"No label images found for this application"},{status:400});let d=JSON.parse(i.expected_label_data),m={},f=Date.now();for(let e of o)try{let{extractedData:t,confidence:r,processingTimeMs:a}=await (0,c.T)(e.image_data,e.mime_type,i.beverage_type),o=(0,u.sr)(d,t),s=(0,u.Kz)(o);p.uH.updateExtraction(e.id,JSON.stringify(t),JSON.stringify(o),r,a),m[e.image_type]=o,"needs_review"===s&&"pending"===i.status&&p.M1.updateStatus(n,"needs_review",null)}catch(t){console.error(`Error processing label image ${e.id}:`,t),m[e.image_type]={error:"Failed to process image",message:t instanceof Error?t.message:"Unknown error"}}let _=Date.now()-f;p.c8.create(a.id,"verified",n,JSON.stringify({processing_time_ms:_}));let g=Object.values(m).flatMap(e=>Object.values(e).filter(e=>"object"==typeof e&&null!==e&&"type"in e)),y=g.some(e=>"hard_mismatch"===e.type||"not_found"===e.type),E=g.some(e=>"soft_mismatch"===e.type);return s.NextResponse.json({application_id:n,verification_results:m,overall_status:y?"pending":E?"needs_review":"pending",processing_time_ms:_})}catch(e){return console.error("Verify application error:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/applications/[id]/verify/route",pathname:"/api/applications/[id]/verify",filename:"route",bundlePath:"app/api/applications/[id]/verify/route"},resolvedPagePath:"/Users/michaeltornaritis/Desktop/Treasury_Take_Home/app/api/applications/[id]/verify/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:g,serverHooks:y}=f,E="/api/applications/[id]/verify/route";function h(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:g})}},9178:(e,t,r)=>{r.d(t,{SO:()=>p,So:()=>c,ed:()=>l,ts:()=>u});var a=r(8691),n=r(8547),i=r(909);let o=new Map;async function s(e,t){return a.ZP.compare(e,t)}function l(e){let t=(0,n.Z)(),r=Date.now()+864e5;return o.set(t,{userId:e,expiresAt:r}),function(){let e=Date.now();for(let[t,r]of o.entries())e>r.expiresAt&&o.delete(t)}(),t}function p(e){o.delete(e)}async function c(e,t){let r=i.tJ.findByEmail(e);return r&&await s(t,r.password_hash)?(i.tJ.updateLastLogin(r.id),i.c8.create(r.id,"login"),r):null}function u(e){if(!e)return null;let t=function(e){let t=o.get(e);return t?Date.now()>t.expiresAt?(o.delete(e),null):{userId:t.userId}:null}(e);return t&&i.tJ.findById(t.userId)||null}},909:(e,t,r)=>{r.d(t,{M1:()=>m,c8:()=>_,uH:()=>f,tJ:()=>d});var a=r(5890),n=r.n(a),i=r(5315),o=r.n(i),s=r(2048),l=r.n(s);let p=process.env.DATABASE_PATH||"./data/database.db",c=o().dirname(p);l().existsSync(c)||l().mkdirSync(c,{recursive:!0});let u=new(n())(p);u.pragma("foreign_keys = ON");let d={create:(e,t,r,a="agent")=>u.prepare(`
      INSERT INTO users (email, password_hash, name, role)
      VALUES (?, ?, ?, ?)
    `).run(e,t,r,a),findByEmail:e=>u.prepare("SELECT * FROM users WHERE email = ?").get(e),findById:e=>u.prepare("SELECT * FROM users WHERE id = ?").get(e),updateLastLogin:e=>u.prepare("UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?").run(e)},m={create:(e,t,r,a=null)=>u.prepare(`
      INSERT INTO applications (applicant_name, beverage_type, expected_label_data, assigned_agent_id)
      VALUES (?, ?, ?, ?)
    `).run(e,t,r,a),findById:e=>u.prepare("SELECT * FROM applications WHERE id = ?").get(e),findAll:()=>u.prepare("SELECT * FROM applications ORDER BY created_at DESC").all(),findByStatus:e=>u.prepare("SELECT * FROM applications WHERE status = ? ORDER BY created_at DESC").all(e),updateStatus:(e,t,r=null)=>u.prepare(`
      UPDATE applications 
      SET status = ?, reviewed_at = CURRENT_TIMESTAMP, review_notes = ?
      WHERE id = ?
    `).run(t,r,e)},f={create:(e,t,r,a)=>u.prepare(`
      INSERT INTO label_images (application_id, image_type, image_data, mime_type)
      VALUES (?, ?, ?, ?)
    `).run(e,t,r,a),findByApplicationId:e=>u.prepare("SELECT * FROM label_images WHERE application_id = ?").all(e),updateExtraction:(e,t,r,a,n)=>u.prepare(`
      UPDATE label_images 
      SET extracted_data = ?, verification_result = ?, confidence_score = ?, 
          processed_at = CURRENT_TIMESTAMP, processing_time_ms = ?
      WHERE id = ?
    `).run(t,r,a,n,e)},_={create:(e,t,r=null,a=null)=>u.prepare(`
      INSERT INTO audit_logs (user_id, application_id, action, details)
      VALUES (?, ?, ?, ?)
    `).run(e,r,t,a),findByUserId:(e,t=100)=>u.prepare(`
      SELECT * FROM audit_logs 
      WHERE user_id = ? 
      ORDER BY timestamp DESC 
      LIMIT ?
    `).all(e,t),findByApplicationId:e=>u.prepare(`
      SELECT * FROM audit_logs 
      WHERE application_id = ? 
      ORDER BY timestamp DESC
    `).all(e)}},2704:(e,t,r)=>{r.d(t,{k:()=>s,m:()=>o});var a=r(7070),n=r(9178),i=r(1615);async function o(e){let t=await (0,i.cookies)(),r=t.get("session")?.value;if(!r)return a.NextResponse.json({error:"Authentication required"},{status:401});let o=(0,n.ts)(r);return o?{user:o}:a.NextResponse.json({error:"Invalid session"},{status:401})}async function s(e){let t=await o(e);return t instanceof a.NextResponse?t:"admin"!==t.user.role?a.NextResponse.json({error:"Admin access required"},{status:403}):t}},354:(e,t,r)=>{r.d(t,{T:()=>n});let a=new(r(1088)).ZP({apiKey:process.env.OPENAI_API_KEY});async function n(e,t,r){let n=Date.now(),i=e.toString("base64"),o=`data:${t};base64,${i}`,s={brand_name:"Brand name",class_type:"Class/type designation",alcohol_content:"Alcohol content percentage",net_contents:"Net contents (volume)",producer_name:"Producer name",producer_address:"Producer address",health_warning:"Government health warning statement (must be exact)"};"spirits"===r?(s.age_statement="Age statement (if applicable)",s.country_of_origin="Country of origin (if imported)"):"wine"===r?(s.appellation_of_origin="Appellation of origin (if applicable)",s.sulfite_declaration="Sulfite declaration",s.country_of_origin="Country of origin (if imported)"):"beer"===r&&(s.sulfite_declaration="Sulfite declaration (if applicable)",s.country_of_origin="Country of origin (if imported)");let l=Object.entries(s).map(([e,t])=>`- ${e}: ${t}`).join("\n");try{let e=await a.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:`You are an expert at extracting structured data from alcohol beverage labels. Extract the following fields from the label image and return them as JSON with confidence scores (0-1) for each field. If a field is not found, omit it from the response. For the health_warning field, extract the EXACT text including case and formatting.

Fields to extract:
${l}

Return JSON in this format:
{
  "brand_name": { "value": "...", "confidence": 0.95 },
  "alcohol_content": { "value": "...", "confidence": 0.92 },
  ...
}`},{role:"user",content:[{type:"text",text:"Extract all label information from this image. Pay special attention to the health warning - it must be extracted exactly as shown, including all caps and formatting."},{type:"image_url",image_url:{url:o}}]}],response_format:{type:"json_object"},max_tokens:2e3}),t=e.choices[0]?.message?.content;if(!t)throw Error("No response from OpenAI");let r=JSON.parse(t),i={};for(let[e,t]of Object.entries(r))t&&"object"==typeof t&&"value"in t&&"confidence"in t&&(i[e]={value:String(t.value),confidence:Number(t.confidence)});let s=Object.values(i).map(e=>e.confidence),p=s.length>0?s.reduce((e,t)=>e+t,0)/s.length:0,c=Date.now()-n;return{extractedData:i,confidence:p,processingTimeMs:c}}catch(e){throw console.error("OpenAI extraction error:",e),e}}},307:(e,t,r)=>{function a(e){return e.toLowerCase().trim().replace(/\s+/g," ")}function n(e,t){let r={};for(let[n,i]of Object.entries(e))if(i){let e=t[n];r[n]=function(e,t,r){var n,i;if(!r||!r.value)return{match:!1,type:"not_found",expected:t};if(!t)return{match:!0,type:"match",extracted:r.value};if("health_warning"===e){let e=t===(n=r.value)?{match:!0,type:"match"}:(t.toUpperCase(),n.toUpperCase().startsWith("GOVERNMENT WARNING:")&&t===n)?{match:!0,type:"match"}:{match:!1,type:"hard_mismatch"};return{match:e.match,type:e.type,expected:t,extracted:r.value}}return t===(i=r.value)||a(t)===a(i)?{match:!0,type:"match",expected:t,extracted:r.value}:!function(e,t){let r=a(e),n=a(t);return r===n&&e!==t||r.replace(/[^\w\s]/g,"")===n.replace(/[^\w\s]/g,"")}(t,r.value)?{match:!1,type:"hard_mismatch",expected:t,extracted:r.value}:{match:!1,type:"soft_mismatch",expected:t,extracted:r.value}}(n,i,e)}return r}function i(e){let t=Object.values(e).some(e=>"hard_mismatch"===e.type||"not_found"===e.type),r=Object.values(e).some(e=>"soft_mismatch"===e.type);return t?"pending":r?"needs_review":"pending"}r.d(t,{Kz:()=>i,sr:()=>n})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,2,88],()=>r(7965));module.exports=a})();