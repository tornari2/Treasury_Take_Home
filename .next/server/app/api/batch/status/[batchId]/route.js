"use strict";(()=>{var e={};e.id=42,e.ids=[42],e.modules={5890:e=>{e.exports=require("better-sqlite3")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},8414:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>g,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{GET:()=>c,dynamic:()=>l});var s=r(9303),o=r(8716),n=r(670),i=r(7070),u=r(8910);let l="force-dynamic";async function c(e,{params:t}){try{let e;let{batchId:r}=t,a=(0,u.P)(r);if(!a)return i.NextResponse.json({error:"Batch not found"},{status:404});if("processing"===a.status&&a.processed>0){let t=(Date.now()-new Date(a.started_at).getTime())/a.processed,r=(a.total_applications-a.processed)*t;e=new Date(Date.now()+r).toISOString()}return i.NextResponse.json({...a,estimated_completion:e})}catch(e){return console.error("Get batch status error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/batch/status/[batchId]/route",pathname:"/api/batch/status/[batchId]",filename:"route",bundlePath:"app/api/batch/status/[batchId]/route"},resolvedPagePath:"/Users/michaeltornaritis/Desktop/Treasury_Take_Home/app/api/batch/status/[batchId]/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:f,serverHooks:h}=p,m="/api/batch/status/[batchId]/route";function g(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},8910:(e,t,r)=>{r.d(t,{P:()=>h,o:()=>f});let a=require("node:crypto"),s={randomUUID:a.randomUUID},o=new Uint8Array(256),n=o.length,i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));var u=r(354),l=r(307),c=r(5185),p=r(5001);let d=new Map;async function f(e){var t,r;let f=s.randomUUID?s.randomUUID():function(e,t,r){let s=(e=e||{}).random??e.rng?.()??(n>o.length-16&&((0,a.randomFillSync)(o),n=0),o.slice(n,n+=16));if(s.length<16)throw Error("Random bytes length must be >= 16");if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=s[e];return t}return function(e,t=0){return(i[e[t+0]]+i[e[t+1]]+i[e[t+2]]+i[e[t+3]]+"-"+i[e[t+4]]+i[e[t+5]]+"-"+i[e[t+6]]+i[e[t+7]]+"-"+i[e[t+8]]+i[e[t+9]]+"-"+i[e[t+10]]+i[e[t+11]]+i[e[t+12]]+i[e[t+13]]+i[e[t+14]]+i[e[t+15]]).toLowerCase()}(s)}(t,r,void 0),h=new Date().toISOString(),m={batch_id:f,status:"processing",total_applications:e.length,processed:0,successful:0,failed:0,started_at:h,results:[]};d.set(f,m);let g=async e=>{let t=e.map(async e=>{try{let t=c.M1.findById(e);if(!t)throw Error(`Application ${e} not found`);let r=c.uH.findByApplicationId(e);if(0===r.length)throw Error(`No label images found for application ${e}`);let a=(0,p.H)(t,r.map(e=>e.id));for(let s of r)try{let{extractedData:r,confidence:o,processingTimeMs:n}=await (0,u.T)(s.image_data,s.mime_type,t.beverage_type),i=(0,l.sr)(a,r),p=(0,l.Kz)(i);c.uH.updateExtraction(s.id,JSON.stringify(r),JSON.stringify(i),o,n),"needs_review"===p&&"pending"===t.status&&c.M1.updateStatus(e,"needs_review",null)}catch(t){throw console.error(`Error processing label image for app ${e}:`,t),t}m.results.push({application_id:e,status:"success"}),m.successful++}catch(t){m.results.push({application_id:e,status:"failed",error:t instanceof Error?t.message:"Unknown error"}),m.failed++}finally{m.processed++,d.set(f,{...m})}});await Promise.allSettled(t)};for(let t=0;t<e.length;t+=10){let r=e.slice(t,t+10);await g(r)}return m.status="completed",d.set(f,m),f}function h(e){return d.get(e)||null}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972,88,335],()=>r(8414));module.exports=a})();